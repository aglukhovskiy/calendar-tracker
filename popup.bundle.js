document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("timer-display"),t=document.getElementById("start-btn"),n=document.getElementById("pause-btn"),a=document.getElementById("stop-btn"),o=document.getElementById("project-select"),l=document.getElementById("calendar-btn");let s=[],c={isRunning:!1,startTimestamp:null,elapsed:0,liveEventId:null,projectId:null};function i(){let l=c.elapsed;c.isRunning&&c.startTimestamp&&(l+=Date.now()-c.startTimestamp);let s=Math.floor(l/1e3),i=Math.floor(s/60);s%=60,e.textContent=`${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`,e.style.color="#fff",t.disabled=c.isRunning||!o.value,n.disabled=!c.isRunning,a.disabled=!c.isRunning&&0===c.elapsed}function r(){chrome.storage.local.get(["projects","selectedProjectId"],(e=>{s=e.projects||[],o.innerHTML='<option value="">-- Проект --</option>',s.forEach((e=>{let t=document.createElement("option");t.value=e.id,t.textContent=e.name,o.appendChild(t)})),e.selectedProjectId&&(o.value=e.selectedProjectId),i()}))}function d(){chrome.storage.local.get("stopwatch",(e=>{e.stopwatch&&(c={...c,...e.stopwatch}),i()}))}chrome.storage.onChanged.addListener(((e,t)=>{"local"===t&&e.stopwatch&&d(),"local"===t&&e.projects&&r()})),t.onclick=function(){let e=o.value;e?chrome.storage.local.set({selectedProjectId:e},(()=>{chrome.storage.local.get(["stopwatch","calendarEvents","projects"],(t=>{if((t.stopwatch||{}).isRunning)return;const n=(t.projects||[]).find((t=>t.id===e)),a=new Date,o=e=>e.toString().padStart(2,"0"),l=e=>e.getFullYear()+"-"+o(e.getMonth()+1)+"-"+o(e.getDate())+"T"+o(e.getHours())+":"+o(e.getMinutes()),s={id:`live-${Date.now()}`,title:n?n.name:"Без проекта",description:"",date:(c=a,`${c.getFullYear()}-${o(c.getMonth()+1)}-${o(c.getDate())}`),startTime:l(a),endTime:l(new Date(a.getTime()+6e4)),projectId:e,isLive:!0,type:"project"};var c;const i=t.calendarEvents||[];i.push(s),chrome.storage.local.set({stopwatch:{isRunning:!0,startTimestamp:Date.now(),elapsed:0,liveEventId:s.id,projectId:e},calendarEvents:i})}))})):alert("Выберите проект!")},n.onclick=function(){chrome.storage.local.get(["stopwatch","calendarEvents"],(e=>{let t=e.stopwatch||{};if(!t.isRunning)return;let n=(t.elapsed||0)+(Date.now()-t.startTimestamp),a=e.calendarEvents||[];if(t.liveEventId){const e=a.findIndex((e=>e.id===t.liveEventId));e>-1&&(a[e].isLive=!1)}chrome.storage.local.set({stopwatch:{...t,isRunning:!1,startTimestamp:null,elapsed:n,projectId:t.projectId||null},calendarEvents:a})}))},a.onclick=function(){chrome.storage.local.get(["stopwatch","calendarEvents"],(e=>{let t=e.stopwatch||{},n=e.calendarEvents||[];if(t.liveEventId){const e=n.findIndex((e=>e.id===t.liveEventId));e>-1&&(n[e].isLive=!1)}chrome.storage.local.set({stopwatch:{isRunning:!1,startTimestamp:null,elapsed:0,liveEventId:null,projectId:null},calendarEvents:n})}))},o.onchange=function(){chrome.storage.local.get("stopwatch",(e=>{let t=e.stopwatch||{};(t.isRunning||t.elapsed)&&chrome.storage.local.set({stopwatch:{isRunning:!1,startTimestamp:null,elapsed:0,liveEventId:null,projectId:o.value}}),chrome.storage.local.set({selectedProjectId:o.value})}))},l.onclick=function(){chrome.tabs.create({url:chrome.runtime.getURL("index.html")})},r(),d(),setInterval(i,1e3)}));