document.addEventListener('DOMContentLoaded', async () => {
    // === Globals ===
    let calendarEvents = [];
    let projects = [];
    let selectedProjectId = null;
    let stopwatch = { isRunning: false, startTimestamp: null, elapsed: 0, liveEventId: null, projectId: null };
    let stopwatchInterval = null;
    let currentDate = new Date();
    let currentWeekStart = getStartOfWeek(currentDate);
    let editingEventId = null;

    let allDayDetailsData = {}; // –ö–µ—à –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞–ª–æ—Ä–∏—è—Ö –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
    const ALL_DAY_DETAILS_KEY = 'allDayDetails';
    let dayDetailsManager = null; // –≠–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∞—Å—Å–∞ DayDetails

    // UI / DOM (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫–∞–∫ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ)
    const timerDisplay = document.getElementById('sidebar-timer-display');
    const startBtn = document.getElementById('start-pomodoro');
    const pauseBtn = document.getElementById('pause-pomodoro');
    const stopBtn = document.getElementById('stop-pomodoro');
    const selectProjectSel = document.getElementById('select-project');
    const addProjectBtn = document.getElementById('add-project');
    const newProjectNameInput = document.getElementById('project-name');
    const projectsListContainer = document.getElementById('projects-list');
    const projectStats = document.getElementById('project-stats');
    const exportCsvBtn = document.getElementById('export-csv');
    const importCsvBtn = document.getElementById('import-csv'); // —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–Ω –µ—Å—Ç—å
    const prevWeekBtn = document.getElementById('prev-week');
    const nextWeekBtn = document.getElementById('next-week');
    const currentWeekBtn = document.getElementById('current-week');
    const openDatePickerBtn = document.getElementById('open-date-picker');
    const daysHeaderContainer = document.querySelector('.days-header');
    const weekGridContainer = document.querySelector('.week-grid');
    const timeSlotsContainer = document.querySelector('.time-slots');
    const eventModal = document.getElementById('event-modal');
    const eventForm = document.getElementById('event-form');
    const eventTitleInput = document.getElementById('event-title');
    const eventDateInput = document.getElementById('event-date');
    const eventStartInput = document.getElementById('event-start');
    const eventEndInput = document.getElementById('event-end');
    const eventDescriptionInput = document.getElementById('event-description');
    const saveEventBtn = document.getElementById('save-event');
    const deleteEventBtn = document.getElementById('delete-event');
    const cancelEventBtn = document.getElementById('cancel-event');
    
    // const modalCloseBtns = document.querySelectorAll('.modal .close-modal'); // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º –Ω–∏–∂–µ
    // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –¥–∞—Ç—ã
    const datePickerModal = document.getElementById('date-picker-modal');
    const calendarGridDom = document.getElementById('calendar-grid');
    const monthTitle = document.getElementById('month-title');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const datePickerSelectBtn = document.getElementById('date-picker-select');
    const datePickerTodayBtn = document.getElementById('date-picker-today');
    const datePickerCancelBtn = document.getElementById('date-picker-cancel');
    const weekdayHeader = document.getElementById('weekday-header');
    const dayDetailModal = document.getElementById('day-detail-modal'); // –ú–æ–¥–∞–ª–∫–∞ –¥–µ—Ç–∞–ª–µ–π –¥–Ω—è

    // –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ó–ê–ö–†–´–¢–ò–Ø –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù
    document.querySelectorAll('.modal .close-modal, .date-picker-modal .close-modal, .day-detail-modal .close-modal').forEach(btn => {
        btn.addEventListener('click', function() {
            const modalToClose = this.closest('.modal, .date-picker-modal, .day-detail-modal');
            if (modalToClose) {
                modalToClose.style.display = "none";
                if (modalToClose.id === 'event-modal') {
                    closeEventModal(); // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ —Å–æ–±—ã—Ç–∏–π
                }
                if (modalToClose.id === 'day-detail-modal' && dayDetailsManager) {
                    dayDetailsManager.closeDayDetailModal(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ –∫–ª–∞—Å—Å–∞
                }
            }
        });
    });

    window.addEventListener('click', function(event) {
        [eventModal, datePickerModal, dayDetailModal].forEach(modal => {
            if (modal && event.target === modal) {
                modal.style.display = "none";
                if (modal.id === 'event-modal') closeEventModal();
                if (modal.id === 'day-detail-modal' && dayDetailsManager) dayDetailsManager.closeDayDetailModal();
            }
        });
    });
    
    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è date picker –∏ —Ç.–¥. –∏–∑ –≤–∞—à–µ–≥–æ –∫–æ–¥–∞ main_page.js –æ—Å—Ç–∞—é—Ç—Å—è...
    // (–∫–æ–¥ date picker modal handlers)
    if (openDatePickerBtn) {
        openDatePickerBtn.addEventListener('click', () => {
           openDatePicker(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
        });
    }
    // ... (datePickerCancelBtn, datePickerSelectBtn, datePickerTodayBtn listeners)


    // ===== UTILS ===== (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    function formatDate(date) {
        const d = new Date(date);
        let month = '' + (d.getMonth() + 1);
        let day = '' + d.getDate();
        const year = d.getFullYear();
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        return [year, month, day].join('-');
    }
    function pad(x) { return x.toString().padStart(2, '0'); }
    function getStartOfWeek(date) {
        let d = new Date(date);
        let day = d.getDay();
        let diff = d.getDate() - day + (day === 0 ? -6 : 1);
        d.setDate(diff);
        d.setHours(0,0,0,0);
        return d;
    }
    function getWeekDates(startDate) {
        let week = [];
        for(let i=0;i<7;i++) {
            let d=new Date(startDate);
            d.setDate(d.getDate()+i);
            week.push(new Date(d));
        }
        return week;
    }
    function minutesSinceMidnight(dateObj) {
        return dateObj.getHours()*60 + dateObj.getMinutes();
    }
    // function dtToLocalString(dt) { ... } // –ï—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å
    function localIso(dt) {
        return dt.getFullYear() + '-' + pad(dt.getMonth()+1) + '-' + pad(dt.getDate()) + 'T' + pad(dt.getHours()) + ':' + pad(dt.getMinutes());
    }
    function localToDate(str) {
        const [y,m,d] = [str.slice(0,4), str.slice(5,7), str.slice(8,10)];
        const [hh,mm] = [str.slice(11,13), str.slice(14,16)];
        return new Date(+y, +m-1, +d, +hh, +mm);
    }
    function getLocalDateString(dt) {
        return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
    }

    // ========== STOPWATCH ========== (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫–∞–∫ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ)
    // ... (–≤–µ—Å—å –∫–æ–¥ —Å–µ–∫—Ü–∏–∏ STOPWATCH) ...
    function updateStopwatchUI() {
        let ms = stopwatch.elapsed;
        if(stopwatch.isRunning && stopwatch.startTimestamp)
            ms += Date.now() - stopwatch.startTimestamp;
        let sec = Math.floor(ms/1000), min = Math.floor(sec/60);
        sec = sec%60;
        let hours = Math.floor(min/60);
        min = min%60;
        
        timerDisplay.textContent = `${hours > 0 ? pad(hours)+':' : ''}${pad(min)}:${pad(sec)}`;
        timerDisplay.style.color="#fff"; 
        startBtn.disabled = stopwatch.isRunning || !selectProjectSel.value;
        pauseBtn.disabled = !stopwatch.isRunning;
        stopBtn.disabled = (!stopwatch.isRunning && stopwatch.elapsed===0);
    }
    function persistStopwatchState() {
        chrome.storage.local.set({stopwatch: {...stopwatch}});
    }
    function syncLiveCalendarEvent() {
        if(!stopwatch.liveEventId) return;
        const evIdx = calendarEvents.findIndex(ev=>ev.id === stopwatch.liveEventId);
        if(evIdx === -1) { // –°–æ–±—ã—Ç–∏–µ –º–æ–≥–ª–æ –±—ã—Ç—å —É–¥–∞–ª–µ–Ω–æ
            stopStopwatch(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä, –µ—Å–ª–∏ –µ–≥–æ —Å–æ–±—ã—Ç–∏—è –Ω–µ—Ç
            return;
        }
        let ms = stopwatch.elapsed;
        if (stopwatch.isRunning && stopwatch.startTimestamp)
            ms += Date.now() - stopwatch.startTimestamp;
        
        let start = localToDate(calendarEvents[evIdx].startTime);
        let durationMin = Math.ceil(ms/60000);
        if (durationMin < 1 && ms > 0) durationMin = 1; // –ï—Å–ª–∏ –≤—Ä–µ–º—è –µ—Å—Ç—å, –Ω–æ –º–µ–Ω—å—à–µ –º–∏–Ω—É—Ç—ã, —Å—Ç–∞–≤–∏–º 1 –º–∏–Ω.
        else if (ms === 0) durationMin = 0; // –ï—Å–ª–∏ –≤—Ä–µ–º—è 0, —Ç–æ –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 0. –û—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –∫–∞–∫ –º–∏–Ω. 15 –ø–æ—Ç–æ–º.

        const end = new Date(start.getTime() + durationMin*60000);
        calendarEvents[evIdx].endTime = localIso(end);
        // calendarEvents[evIdx].date = getLocalDateString(start); // –î–∞—Ç–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
        chrome.storage.local.set({calendarEvents}); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è
        renderWeekGrid(currentWeekStart); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–µ—Ç–∫—É
    }
    function handleLiveEventExpansion() {
        if (!stopwatch.isRunning || !stopwatch.liveEventId) return;
        syncLiveCalendarEvent();
    }
    function startStopwatch() {
        if (stopwatch.isRunning || !selectProjectSel.value) return;
        
        stopwatch.isRunning = true;
        stopwatch.startTimestamp = Date.now();
        // stopwatch.elapsed = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ "–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å" (—Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        if (!stopwatch.elapsed) stopwatch.elapsed = 0; // –ï—Å–ª–∏ –Ω–µ –±—ã–ª–æ –ø–∞—É–∑—ã, –Ω–∞—á–∏–Ω–∞–µ–º —Å 0

        stopwatch.projectId = selectProjectSel.value;
        
        const project = projects.find(p => p.id === stopwatch.projectId);
        const now = new Date();
        const liveEv = {
            id: `live-${Date.now()}`,
            title: `–†–∞–±–æ—Ç–∞: ${project ? project.name : "–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞"}`,
            description: "–°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–æ–º",
            date: getLocalDateString(now),
            startTime: localIso(now),
            endTime: localIso(new Date(now.getTime() + 60000)), // –ù–∞—á–Ω–µ–º —Å 1 –º–∏–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            projectId: stopwatch.projectId,
            isLive: true,
            type: 'project' 
        };
        calendarEvents.push(liveEv);
        stopwatch.liveEventId = liveEv.id;
        chrome.storage.local.set({calendarEvents});
        
        if(stopwatchInterval) clearInterval(stopwatchInterval);
        stopwatchInterval = setInterval(()=> {
            updateStopwatchUI();
            handleLiveEventExpansion();
        }, 1000);
        updateStopwatchUI();
        persistStopwatchState();
    }
    function pauseStopwatch() {
        if (!stopwatch.isRunning) return;
        stopwatch.isRunning = false;
        if (stopwatch.startTimestamp)
            stopwatch.elapsed += Date.now() - stopwatch.startTimestamp;
        stopwatch.startTimestamp = null;
        clearInterval(stopwatchInterval);
        updateStopwatchUI();
        // –ù–µ –≤—ã–∑—ã–≤–∞–µ–º finishLiveEvent –ø—Ä–∏ –ø–∞—É–∑–µ, —Å–æ–±—ã—Ç–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è "–∂–∏–≤—ã–º"
        syncLiveCalendarEvent(); // –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–±—ã—Ç–∏—è
        persistStopwatchState();
    }
    function stopStopwatch() {
        const wasRunning = stopwatch.isRunning;
        stopwatch.isRunning = false;
        if (wasRunning && stopwatch.startTimestamp) {
             stopwatch.elapsed += Date.now() - stopwatch.startTimestamp;
        }
        stopwatch.startTimestamp = null;
        clearInterval(stopwatchInterval);
        
        if (stopwatch.liveEventId) {
            syncLiveCalendarEvent(); // –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
            finishLiveEvent(stopwatch.liveEventId); // –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ, —É–±–∏—Ä–∞—è isLive
        }
        
        stopwatch.elapsed = 0;
        stopwatch.liveEventId = null; 
        // stopwatch.projectId = null; // –†–µ—à–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
        updateStopwatchUI();
        persistStopwatchState();
    }

    function finishLiveEvent(eventIdToFinish) {
        if (!eventIdToFinish) return;
        const evIdx = calendarEvents.findIndex(ev => ev.id === eventIdToFinish);
        if (evIdx > -1) {
            calendarEvents[evIdx].isLive = false;
            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞, –µ—Å–ª–∏ –±—ã–ª–∞ –Ω—É–ª–µ–≤–∞—è
            const start = localToDate(calendarEvents[evIdx].startTime);
            const end = localToDate(calendarEvents[evIdx].endTime);
            if (end <= start) {
                 calendarEvents[evIdx].endTime = localIso(new Date(start.getTime() + 15*60000)); // –ú–∏–Ω. 15 –º–∏–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            }
            chrome.storage.local.set({calendarEvents});
            renderWeekGrid(currentWeekStart);
        }
    }
    startBtn.addEventListener('click', startStopwatch);
    pauseBtn.addEventListener('click', pauseStopwatch);
    stopBtn.addEventListener('click', stopStopwatch);

    function loadStopwatchState() {
        chrome.storage.local.get('stopwatch', res => {
            if (res.stopwatch) {
                const oldProjectId = stopwatch.projectId;
                stopwatch = {...stopwatch, ...res.stopwatch}; // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

                if (stopwatch.liveEventId && !calendarEvents.find(ev => ev.id === stopwatch.liveEventId)) {
                    // –ï—Å–ª–∏ "–∂–∏–≤–æ–µ" —Å–æ–±—ã—Ç–∏–µ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ
                    stopwatch.liveEventId = null;
                    stopwatch.isRunning = false; // –ù–µ—á–µ–º—É —Ä–∞–±–æ—Ç–∞—Ç—å
                    // stopwatch.elapsed = 0; // –ú–æ–∂–Ω–æ –∏ –≤—Ä–µ–º—è —Å–±—Ä–æ—Å–∏—Ç—å
                }
                 // –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –±—ã–ª —Å–º–µ–Ω–µ–Ω –ø–æ–∫–∞ —Ç–∞–π–º–µ—Ä —Ä–∞–±–æ—Ç–∞–ª (—Ä–µ–¥–∫–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ storage)
                if (stopwatch.isRunning && oldProjectId && stopwatch.projectId && oldProjectId !== stopwatch.projectId) {
                   // stopStopwatch(); // –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –∏–ª–∏ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –Ω–æ–≤—ã–º –ø—Ä–æ–µ–∫—Ç–æ–º?
                }
            }
            if (stopwatch.isRunning && stopwatch.projectId && stopwatch.liveEventId) {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç, –µ—Å–ª–∏ –æ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä—É
                if (selectProjectSel.value !== stopwatch.projectId ) {
                    selectProjectSel.value = stopwatch.projectId;
                    if (!selectProjectSel.value) { // –ï—Å–ª–∏ —Ç–∞–∫–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ—Ç, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
                        stopStopwatch();
                        return;
                    }
                }
                if (stopwatchInterval) clearInterval(stopwatchInterval);
                stopwatchInterval = setInterval(()=> {
                    updateStopwatchUI();
                    handleLiveEventExpansion();
                }, 1000);
            } else {
                if (stopwatchInterval) clearInterval(stopwatchInterval);
            }
            updateStopwatchUI();
        });
    }
    
    // ==== –ü–†–û–ï–ö–¢–´ ==== (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫–∞–∫ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ)
    // ... (–≤–µ—Å—å –∫–æ–¥ —Å–µ–∫—Ü–∏–∏ –ü–†–û–ï–ö–¢–´) ...
    function renderProjectSelectAndList() {
        if (selectProjectSel) {
            const currentSelectedVal = selectProjectSel.value;
            selectProjectSel.innerHTML = `<option value="">-- –ü—Ä–æ–µ–∫—Ç --</option>`;
            projects.forEach(prj => {
                const opt = document.createElement('option');
                opt.value = prj.id;
                opt.textContent = prj.name;
                selectProjectSel.appendChild(opt);
            });
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±–æ—Ä, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∏ –ø—Ä–æ–µ–∫—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (projects.find(p => p.id === currentSelectedVal)) {
                selectProjectSel.value = currentSelectedVal;
            } else if (projects.find(p => p.id === selectedProjectId)) {
                selectProjectSel.value = selectedProjectId;
            } else {
                selectProjectSel.value = ""; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ—Ç
            }
        }
        if (projectsListContainer) {
            projectsListContainer.innerHTML = '';
            projects.forEach(project => {
                const div = document.createElement('div');
                div.className = 'project-item';
                div.innerHTML = `
                    <span class="project-name-display">${project.name}</span>
                    <button class="delete-project delete-project-btn" data-id="${project.id}" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç">üóëÔ∏è</button>
                `;
                projectsListContainer.appendChild(div);
            });
        }
        updateStopwatchUI();
    }

    if (selectProjectSel) {
        selectProjectSel.addEventListener('change', e => {
            const newProjectId = selectProjectSel.value;
            if (stopwatch.isRunning && stopwatch.projectId !== newProjectId) {
                
                if (confirm("–°–µ–∫—É–Ω–¥–æ–º–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∏ –Ω–∞—á–∞—Ç—å –¥–ª—è –Ω–æ–≤–æ–≥–æ, –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å —Å–º–µ–Ω—É –ø—Ä–æ–µ–∫—Ç–∞? (–û–ö –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ —Å–º–µ–Ω—ã, –û—Ç–º–µ–Ω–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ä–∞–±–æ—Ç—ã)")) {
                    stopStopwatch();
                    selectedProjectId = newProjectId;
                    chrome.storage.local.set({selectedProjectId});
                     // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, –µ—Å–ª–∏ –±—ã–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –≤—Ä–µ–º–µ–Ω–∏
                    // if (stopwatch.elapsed > 0) startStopwatch(); // –ù–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ
                } else {
                    selectProjectSel.value = stopwatch.projectId; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ–µ–∫—Ç
                    return;
                }
            } else {
                selectedProjectId = newProjectId;
                chrome.storage.local.set({selectedProjectId});
            }
            renderProjectStats(selectedProjectId);
            updateStopwatchUI();
        });
    }
    if (projectsListContainer) {
        projectsListContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-project-btn')) {
                const id = e.target.getAttribute("data-id");
                const projectToDelete = projects.find(p => p.id === id);
                if (projectToDelete && confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç "${projectToDelete.name}"? –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –æ—Å—Ç–∞–Ω—É—Ç—Å—è, –Ω–æ –ø–æ—Ç–µ—Ä—è—é—Ç –ø—Ä–∏–≤—è–∑–∫—É –∫ –ø—Ä–æ–µ–∫—Ç—É.`)) {
                    projects = projects.filter(p => p.id !== id);
                    calendarEvents.forEach(ev => {
                        if (ev.projectId === id) {
                            ev.projectId = null; 
                        }
                    });

                    if (selectedProjectId === id) {
                        selectedProjectId = null;
                        selectProjectSel.value = '';
                    }
                    if (stopwatch.projectId === id) {
                        stopStopwatch();
                    }
                    chrome.storage.local.set({projects, calendarEvents, selectedProjectId});
                    renderProjectSelectAndList();
                    renderProjectStats(selectedProjectId); // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                }
            }
        });
    }
    if (addProjectBtn && newProjectNameInput) {
        addProjectBtn.addEventListener('click', () => {
            const val = newProjectNameInput.value.trim();
            if (!val) { 
                alert("–ò–º—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.");
                return;
            }
            if (projects.find(p => p.name.toLowerCase() === val.toLowerCase())) {
                alert("–ü—Ä–æ–µ–∫—Ç —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.");
                return;
            }
            const id = `prj-${Date.now()}`;
            projects.push({id, name: val});
            chrome.storage.local.set({projects});
            newProjectNameInput.value = '';
            renderProjectSelectAndList();
            selectProjectSel.value = id; // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
            selectedProjectId = id;
            chrome.storage.local.set({selectedProjectId: id});
            renderProjectStats(id);
        });
    }
    function renderProjectStats(projId) {
        if (!projectStats) return;
        projectStats.innerHTML = '';
        if (!projId) {
             projectStats.textContent = '–ü—Ä–æ–µ–∫—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω.';
            return;
        }
        const project = projects.find(p => p.id === projId);
        if (!project) {
            projectStats.textContent = '–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.';
            return;
        }
        let totalMin = 0;
        calendarEvents.filter(ev => ev.projectId === projId && ev.type === 'project').forEach(ev => { // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è —Ç–∏–ø–∞ 'project'
            let d = Math.max(0, Math.round((localToDate(ev.endTime) - localToDate(ev.startTime)) / 60000));
            totalMin += d;
        });
        const hours = Math.floor(totalMin / 60);
        const minutes = totalMin % 60;
        projectStats.innerHTML = `<b>${project.name}</b>: ${hours > 0 ? `${hours} —á ` : ''}${minutes} –º–∏–Ω.`;
    }

    // ==== –ö–ê–õ–ï–ù–î–ê–†–¨ ====
    function renderTimeSlots() {
        // ... (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        if (!timeSlotsContainer) return;
        timeSlotsContainer.innerHTML = '';
        for (let h = 0; h < 24; h++) {
            const div = document.createElement('div');
            div.className = 'time-slot';
            div.textContent = pad(h) + ':00';
            timeSlotsContainer.appendChild(div);
        }
    }

    function renderDaysHeader(weekStart) {
        if (!daysHeaderContainer) return;
        daysHeaderContainer.innerHTML = '';
        const weekDates = getWeekDates(weekStart);
        
        weekDates.forEach(date => {
            const dateStr = formatDate(date);
            const dayData = allDayDetailsData[dateStr]; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const totalCalories = dayData && dayData.calories ? 
                (dayData.calories.morning + dayData.calories.afternoon + dayData.calories.evening) : 0;
            const commentExists = dayData && dayData.comment && dayData.comment.trim() !== '';

            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header';
            dayHeader.setAttribute('data-date', dateStr);
            if (formatDate(date) === formatDate(new Date())) { // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –¥–∞—Ç
                dayHeader.classList.add('today-header');
            }
            dayHeader.innerHTML = `
                <div class="day-name">${date.toLocaleDateString('ru-RU', { weekday: 'short' })}</div>
                <div class="day-date">${pad(date.getDate())}.${pad(date.getMonth() + 1)}</div>
                <div class="day-header-icons">
                    <span class="calories-icon" style="display: ${totalCalories > 0 ? 'inline' : 'none'}">
                        üî• ${totalCalories > 0 ? totalCalories : ''}
                    </span>
                    <span class="comment-icon" style="display: ${commentExists ? 'inline' : 'none'}">üìù</span>
                </div>
            `;
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ –¥–µ—Ç–∞–ª–µ–π –¥–Ω—è
            dayHeader.addEventListener('click', () => {
                if (dayDetailsManager) {
                    dayDetailsManager.openDayDetailModal(dateStr);
                }
            });
            daysHeaderContainer.appendChild(dayHeader);
        });
    }
    function renderWeekGrid(weekStart) {
        if (!weekGridContainer) return;
        weekGridContainer.innerHTML = '';
        const weekDates = getWeekDates(weekStart);
    
        for (let col = 0; col < 7; col++) {
            const dayCol = document.createElement('div');
            dayCol.className = 'day-column';
            const dateStr = formatDate(weekDates[col]);
            dayCol.dataset.date = dateStr;
            if (dateStr === formatDate(new Date())) {
                dayCol.classList.add('current-day');
            }
    
            for (let h = 0; h < 24; h++) {
                const hourCell = document.createElement('div');
                hourCell.className = 'hour-cell';
                hourCell.dataset.hour = h;
                hourCell.dataset.date = dateStr;
    
                // =======================
                // –¢–æ–ª—å–∫–æ –¥–ª—è –†–ê–ó–ú–ï–¢–ö–ò!
                for (let q = 0; q < 4; q++) {
                    const quarterCell = document.createElement('div');
                    quarterCell.className = 'quarter-cell';
                    quarterCell.dataset.quarter = q;
                    hourCell.appendChild(quarterCell);
                }
                // =======================
    
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —è—á–µ–π–∫–∏ —á–∞—Å–∞
                hourCell.addEventListener('click', function(e) {
                    // –ù–µ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ, –µ—Å–ª–∏ –∫–ª–∏–∫ –ø–æ —Å–æ–±—ã—Ç–∏—é
                    if (e.target.closest('.event')) return;
    
                    const rect = this.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    const quarter = Math.floor(y / (this.offsetHeight / 4));
                    const minute = quarter * 15;
                    createEventAt(dateStr, h, minute);
                });
    
                dayCol.appendChild(hourCell);
            }
            weekGridContainer.appendChild(dayCol);
        }
    
        renderEvents();
        updateCurrentTimeIndicator && updateCurrentTimeIndicator();
    }
    
    

    function renderEvents() {
        // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è –∏–∑ —è—á–µ–µ–∫
        weekGridContainer.querySelectorAll('.event').forEach(el => el.remove());

        const weekStartStr = formatDate(currentWeekStart);
        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(currentWeekStart.getDate() + 6);
        const weekEndStr = formatDate(weekEnd);

        calendarEvents.filter(ev => ev.date >= weekStartStr && ev.date <= weekEndStr)
        .sort((a,b) => localToDate(a.startTime) - localToDate(b.startTime)) // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ Z-index –µ—Å–ª–∏ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç—Å—è
        .forEach(ev => {
            const start = localToDate(ev.startTime);
            const end = localToDate(ev.endTime);
            const col = Array.from(weekGridContainer.children).find(dc => dc.dataset.date === ev.date);
            if (!col) return;

            let sMin = minutesSinceMidnight(start);
            let eMin = minutesSinceMidnight(end);
            
            if (eMin <= sMin) eMin = sMin + 15; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 15 –º–∏–Ω—É—Ç
            let duration = eMin - sMin;
            if (duration <= 0) duration = 15;

            let h = start.getHours();
            // –ò—â–µ–º —è—á–µ–π–∫—É —á–∞—Å–∞ –≤ —Ç–µ–∫—É—â–µ–π –∫–æ–ª–æ–Ω–∫–µ –¥–Ω—è
            let hourCell = col.querySelector(`.hour-cell[data-hour="${h}"]`);
            if (!hourCell) return;

            const eventEl = document.createElement('div');
            eventEl.className = 'event';
            eventEl.classList.add(ev.type === 'project' ? 'pomodoro-event' : 'regular-event'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è
            if (ev.isLive) {
                eventEl.classList.add('live-event-indicator'); // –î–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–ª–∏—á–∏—è "–∂–∏–≤—ã—Ö" —Å–æ–±—ã—Ç–∏–π
            }
            
            const hourCellHeight = hourCell.offsetHeight; // –û–±—ã—á–Ω–æ 60px –∏–∑ CSS
            const topOffset = (start.getMinutes() / 60) * hourCellHeight;
            const eventHeight = (duration / 60) * hourCellHeight;
            
            eventEl.style.top = `${topOffset}px`;
            eventEl.style.height = `${Math.max(eventHeight, 15)}px`; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ
            
            eventEl.title = `${ev.title}\n${pad(start.getHours())}:${pad(start.getMinutes())} - ${pad(end.getHours())}:${pad(end.getMinutes())}${ev.description ? '\n' + ev.description : ''}`;
            eventEl.innerHTML = `<div class="event-title">${ev.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                                 <div class="event-time">${pad(start.getHours())}:${pad(start.getMinutes())} - ${pad(end.getHours())}:${pad(end.getMinutes())}</div>`;
            if (ev.description) {
                 eventEl.innerHTML += `<div class="event-description-preview">${ev.description.substring(0,30)}${ev.description.length > 30 ? '...' : ''}</div>`;
            }

            eventEl.addEventListener('click', function(ee) {
                console.log("–ö–ª–∏–∫ –ø–æ —Å–æ–±—ã—Ç–∏—é:", ev.id);
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ –∏ –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
                ee.stopPropagation();
                ee.preventDefault(); 
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω–Ω—ã–º, —á—Ç–æ –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—é—Ç
                setTimeout(() => {
                    openEditEventModal(ev.id);
                }, 10);
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ, –¥–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–≤—Ä–∞—Ç false –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è
                return false;
            });
            hourCell.appendChild(eventEl);
        });
    }

    function createEventAt(date, hour, minute) {
        const projectId = selectedProjectId || (projects.length > 0 ? projects[0].id : null); // –ü—Ä–æ–µ–∫—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const start = new Date(date + "T00:00:00"); // –ò—Å–ø–æ–ª—å–∑—É–µ–º "T00:00:00" —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –ø–æ—è—Å–∞–º–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
        start.setHours(hour, minute, 0, 0);
        
        // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 —á–∞—Å, –∏–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞ —á–∞—Å–∞
        let end = new Date(start.getTime() + 60 * 60000); // +1 —á–∞—Å
        if (end.getDate() !== start.getDate()) { // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
             end = new Date(date + "T23:59:00"); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–º –¥–Ω–µ–º
        }
    
        console.log(`createEventAt: date=${date}, hour=${hour}, minute=${minute}`);
        console.log(`createEventAt: start=${start.toISOString()}, end=${end.toISOString()}`);
    
        const newEvent = {
            id: `evt-${Date.now()}`,
            title: "–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ",
            description: "",
            date,
            startTime: localIso(start),
            endTime: localIso(end),
            projectId,
            type: 'event' // –¢–∏–ø –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'event'
        };
        console.log("–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ:", newEvent);
        calendarEvents.push(newEvent);
        chrome.storage.local.set({calendarEvents});
        openEditEventModal(newEvent.id);
    }
    

    function openEditEventModal(eventId) {
        editingEventId = eventId;
        const ev = calendarEvents.find(e => e.id === eventId);
        if (!ev) return;
        
        eventModal.querySelector('#modal-header').textContent = ev.isLive ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (Live)" : "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ";
        eventTitleInput.value = ev.title;
        eventDateInput.value = ev.date;
        eventStartInput.value = ev.startTime.slice(11,16);
        eventEndInput.value = ev.endTime.slice(11,16);
        eventDescriptionInput.value = ev.description || '';
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –º–æ–¥–∞–ª–∫–µ —Å–æ–±—ã—Ç–∏—è (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ HTML)
        const eventProjectSelect = eventModal.querySelector('#event-project-select'); 
        if (eventProjectSelect) {
            eventProjectSelect.innerHTML = '<option value="">-- –ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞ --</option>';
            projects.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                if (p.id === ev.projectId) option.selected = true;
                eventProjectSelect.appendChild(option);
            });
        }

        deleteEventBtn.style.display = ev.isLive ? 'none' : 'inline-block'; // –ù–µ–ª—å–∑—è —É–¥–∞–ª—è—Ç—å live-—Å–æ–±—ã—Ç–∏–µ –∏–∑ —ç—Ç–æ–π —Ñ–æ—Ä–º—ã
        eventModal.style.display = 'block';
    }
    function closeEventModal() {
        eventModal.style.display = 'none';
        editingEventId = null;
        if (eventForm) eventForm.reset(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    }
    if (eventForm) {
        eventForm.onsubmit = (e) => {
            e.preventDefault();
            const evIndex = calendarEvents.findIndex(e => e.id === editingEventId);
            if (evIndex === -1) return;

            const ev = calendarEvents[evIndex];

            if (ev.isLive && (eventDateInput.value !== ev.date || eventStartInput.value !== ev.startTime.slice(11,16))) {
                alert("–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –¥–∞—Ç—É –∏–ª–∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–∞. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.");
                return;
            }

            ev.title = eventTitleInput.value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            ev.description = eventDescriptionInput.value.trim();
            
            const newDate = eventDateInput.value;
            let [sh, sm] = eventStartInput.value.split(':').map(Number);
            let [eh, em] = eventEndInput.value.split(':').map(Number);

            let dtStart = new Date(newDate + "T00:00:00"); // –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∞—Ç—ã
            dtStart.setHours(sh, sm, 0, 0);
            
            let dtEnd = new Date(newDate + "T00:00:00");
            dtEnd.setHours(eh, em, 0, 0);

            if (dtEnd <= dtStart) {
                dtEnd = new Date(dtStart.getTime() + 15*60000); // –ú–∏–Ω. –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 15 –º–∏–Ω
                // alert("–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –±—ã–ª–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 15 –º–∏–Ω—É—Ç).");
            }
            
            ev.date = newDate;
            ev.startTime = localIso(dtStart);
            ev.endTime = localIso(dtEnd);

            const eventProjectSelect = eventModal.querySelector('#event-project-select');
            if (eventProjectSelect) ev.projectId = eventProjectSelect.value || null; // '' –∏–ª–∏ null –¥–ª—è "–±–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞"

            chrome.storage.local.set({calendarEvents});
            closeEventModal();
            renderWeekGrid(currentWeekStart);
            renderProjectStats(selectedProjectId); 
        };
    }
    if(cancelEventBtn) cancelEventBtn.addEventListener('click', (e) => { e.preventDefault(); closeEventModal(); });
    if(deleteEventBtn) {
        deleteEventBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!editingEventId) return;
            const evToDelete = calendarEvents.find(ev => ev.id === editingEventId);
            if (evToDelete && evToDelete.isLive) {
                 alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–∞. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä —Å–Ω–∞—á–∞–ª–∞.");
                return;
            }

            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ?')) {
                calendarEvents = calendarEvents.filter(ev => ev.id !== editingEventId);
                chrome.storage.local.set({calendarEvents});
                closeEventModal();
                renderWeekGrid(currentWeekStart);
                renderProjectStats(selectedProjectId);
            }
        });
    }

    // ==== –ö–∞–ª–µ–Ω–¥–∞—Ä—å ‚Äî –≤—ã–±–æ—Ä –¥–∞—Ç—ã (Date Picker) ==== (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫–∞–∫ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ)
    let selectedPickerYear = currentDate.getFullYear();
    let selectedPickerMonth = currentDate.getMonth();

    function openDatePicker() { // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —É–∂–µ –±—ã–ª–∞, –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º
        selectedPickerYear = currentDate.getFullYear(); // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
        selectedPickerMonth = currentDate.getMonth();
        datePickerModal.style.display = 'block';
        // datePickerModal.style.position = 'fixed'; // –≠—Ç–æ –ª—É—á—à–µ –≤ CSS
        // ...
        renderDatePickerCalendar(selectedPickerYear, selectedPickerMonth);
    }
    // openDatePickerBtn.addEventListener('click', openDatePicker); // –£–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –≤—ã—à–µ
    if(datePickerCancelBtn) datePickerCancelBtn.addEventListener('click', ()=>datePickerModal.style.display='none');
    if(datePickerTodayBtn) {
        datePickerTodayBtn.addEventListener('click', ()=>{
            const today = new Date();
            selectedPickerYear = today.getFullYear();
            selectedPickerMonth = today.getMonth();
            renderDatePickerCalendar(selectedPickerYear, selectedPickerMonth);
            // –ò —Å—Ä–∞–∑—É –≤—ã–±—Ä–∞—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å
            currentDate = new Date(formatDate(today) + "T00:00:00"); // –û–±–Ω–æ–≤–ª—è–µ–º currentDate
            currentWeekStart = getStartOfWeek(currentDate);
            renderDaysHeader(currentWeekStart);
            renderWeekGrid(currentWeekStart);
            datePickerModal.style.display='none';
        });
    }
    if(datePickerSelectBtn) {
        datePickerSelectBtn.addEventListener('click', ()=>{
            const sel = calendarGridDom.querySelector('.calendar-day.selected');
            if(sel) {
                const datestr = sel.dataset.date;
                currentDate = new Date(datestr + "T00:00:00"); // –û–±–Ω–æ–≤–ª—è–µ–º currentDate
                currentWeekStart = getStartOfWeek(currentDate);
                renderDaysHeader(currentWeekStart);
                renderWeekGrid(currentWeekStart);
                datePickerModal.style.display='none';
            } else {
                alert("–î–∞—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.");
            }
        });
    }
    if(prevMonthBtn) {
        prevMonthBtn.addEventListener('click', ()=>{
            selectedPickerMonth--;
            if(selectedPickerMonth<0) {selectedPickerMonth=11;selectedPickerYear--;}
            renderDatePickerCalendar(selectedPickerYear, selectedPickerMonth);
        });
    }
    if(nextMonthBtn) {
        nextMonthBtn.addEventListener('click', ()=>{
            selectedPickerMonth++;
            if(selectedPickerMonth>11) {selectedPickerMonth=0;selectedPickerYear++;}
            renderDatePickerCalendar(selectedPickerYear, selectedPickerMonth);
        });
    }

    function renderDatePickerCalendar(year, month) {
        if (!monthTitle || !calendarGridDom || !weekdayHeader) return; // –ó–∞—â–∏—Ç–∞
        monthTitle.textContent = `${new Date(year, month).toLocaleString('ru-RU', { month: 'long' })} ${year}`;
        calendarGridDom.innerHTML = '';
        if (weekdayHeader.children.length === 0) { // –†–µ–Ω–¥–µ—Ä–∏–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ –æ–¥–∏–Ω —Ä–∞–∑
             ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].map(d=>weekdayHeader.innerHTML += `<span>${d}</span>`);
        }
        
        const firstOfMonth = new Date(year, month, 1);
        const lastOfMonth = new Date(year, month + 1, 0);
        
        let dayElements = [];
        // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –¥–Ω–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        let firstDayOfWeek = (firstOfMonth.getDay() + 6) % 7; // 0 (–ü–Ω) –¥–æ 6 (–í—Å)
        for (let i = 0; i < firstDayOfWeek; i++) {
            dayElements.push(`<div class="calendar-day other-month"></div>`);
        }

        // –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        for (let day = 1; day <= lastOfMonth.getDate(); day++) {
            let dt = new Date(year, month, day);
            let dateStr = formatDate(dt);
            let classes = 'calendar-day';
            if (dateStr === formatDate(currentDate)) classes += ' selected'; // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            if (dateStr === formatDate(new Date())) classes += ' today-picker'; // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –≤ –ø–∏–∫–µ—Ä–µ
            dayElements.push(`<div class="${classes}" data-date="${dateStr}">${day}</div>`);
        }
        calendarGridDom.innerHTML = dayElements.join('');

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–Ω–µ–π –≤ –ø–∏–∫–µ—Ä–µ
        calendarGridDom.querySelectorAll('.calendar-day:not(.other-month)').forEach(dayDiv => {
            dayDiv.addEventListener('click', function() {
                calendarGridDom.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
                this.classList.add('selected');
                // –ù–µ –º–µ–Ω—è–µ–º currentDate –∑–¥–µ—Å—å, —ç—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–í—ã–±—Ä–∞—Ç—å"
            });
        });
    }


    // ==== –ù–µ–¥–µ–ª—è –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ ==== (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    prevWeekBtn.addEventListener('click', ()=>{
        currentDate.setDate(currentDate.getDate()-7); // –û–±–Ω–æ–≤–ª—è–µ–º currentDate –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ date picker
        currentWeekStart.setDate(currentWeekStart.getDate()-7);
        renderDaysHeader(currentWeekStart); renderWeekGrid(currentWeekStart);
    });
    nextWeekBtn.addEventListener('click', ()=>{
        currentDate.setDate(currentDate.getDate()+7);
        currentWeekStart.setDate(currentWeekStart.getDate()+7);
        renderDaysHeader(currentWeekStart); renderWeekGrid(currentWeekStart);
    });
    currentWeekBtn.addEventListener('click', ()=>{
        currentDate = new Date();
        currentWeekStart = getStartOfWeek(currentDate);
        renderDaysHeader(currentWeekStart); renderWeekGrid(currentWeekStart);
    });

    // ==== –≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç ====
    if (exportCsvBtn) {
        exportCsvBtn.addEventListener('click', exportToCSV); // async function
    }    if (importCsvBtn) {
        importCsvBtn.addEventListener('click', () => {
            let fileInp = document.createElement('input');
            fileInp.type = 'file';
            fileInp.accept = '.csv'; // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ CSV
            fileInp.style.display = 'none';

            fileInp.addEventListener('change', function () {
                if (!fileInp.files || fileInp.files.length === 0) {
                    if (fileInp.parentNode) fileInp.remove();
                    return;
                }
                const selectedFile = fileInp.files[0];
                let reader = new FileReader();

                reader.onload = function (e) {
                    let txt = e.target.result;
                    console.log(`Import (Per-Day): Raw text from file (${selectedFile.name}, size: ${txt.length}):\n` + txt.substring(0, 500) + (txt.length > 500 ? "..." : ""));
                    
                    const lines = txt.split(/\r\n|\n|\r/); // –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫
                    if (lines.length < 1) { // –ù—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã –∑–∞–≥–æ–ª–æ–≤–æ–∫
                        alert("–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫.");
                        if (fileInp.parentNode) fileInp.remove();
                        return;
                    }

                    let importedCalendarEvents = [];
                    let importedAllDayDetails = {};
                    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ –±—É–¥—É—Ç –Ω–∞–π–¥–µ–Ω—ã –≤ –∫–æ–Ω—Ü–µ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º –∏–ª–∏ –µ—Å–ª–∏ –º—ã –∏—Ö –≤–µ—Ä–Ω–µ–º)
                    let importedProjects = [];
                    let importedSelectedProjectId = null;
                    let importedStopwatch = { isRunning: false, elapsed: 0, startTimestamp: null, liveEventId: null, projectId: null };

                    let parseError = null;
                    let headerMap = {};
                    let headerProcessed = false;
                    let dataLinesProcessed = 0;

                    for (let i = 0; i < lines.length; i++) {
                        let line = lines[i].trim();
                        if (!line) continue;

                        // –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å JSON-–±–ª–æ–∫ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ)
                        // –≠—Ç–æ—Ç –±–ª–æ–∫ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–Ω–∞—á–∞—â–µ–π —Å—Ç—Ä–æ–∫–æ–π
                        // –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º—ã–µ –∫–ª—é—á–∏.
                        if (i === lines.length - 1 || (i === lines.length - 2 && !lines[lines.length - 1].trim())) { // –ü–æ—Å–ª–µ–¥–Ω—è—è –∏–ª–∏ –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω—è—è (–µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø—É—Å—Ç–∞—è)
                            if (line.startsWith('{') && line.endsWith('}')) {
                                try {
                                    const metadata = JSON.parse(line);
                                    let processedAsMetadata = false;
                                    if (metadata.projects !== undefined) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
                                        importedProjects = metadata.projects;
                                        processedAsMetadata = true;
                                    }
                                    if (metadata.selectedProjectId !== undefined) {
                                        importedSelectedProjectId = metadata.selectedProjectId;
                                        processedAsMetadata = true;
                                    }
                                    if (metadata.stopwatch !== undefined) {
                                        importedStopwatch = metadata.stopwatch;
                                        processedAsMetadata = true;
                                    }
                                    if (processedAsMetadata) {
                                        console.log("Import (Per-Day): Processed trailing metadata JSON block:", metadata);
                                        break; // –ï—Å–ª–∏ —ç—Ç–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞, –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö CSV –Ω–µ –æ–∂–∏–¥–∞–µ–º
                                    }
                                } catch (err) {
                                     // –ù–µ –Ω–∞—à JSON, –∏–ª–∏ –Ω–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å JSON —Å–æ–±—ã—Ç–∏–π –¥–Ω—è.
                                }
                            }
                        }

                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ CSV. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤–æ–π –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.
                        if (!headerProcessed) {
                            // –ë–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤—ã–π –ø–∞—Ä—Å–µ—Ä –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–∏ –¥–∞–Ω–Ω—ã—Ö)
                            const headerFields = parseCsvLine(line);
                            if (headerFields.length === 0 || (headerFields.length === 1 && !headerFields[0])) {
                                console.warn("Import (Per-Day): Skipping empty or malformed header line:", line);
                                continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø—É—Å—Ç–∞—è –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞—è
                            }

                            headerFields.forEach((h, idx) => headerMap[h.trim()] = idx); // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏–∑ –∏–º–µ–Ω –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
                            
                            const expectedHeaderEvents = "–°–æ–±—ã—Ç–∏—è –î–Ω—è (JSON)"; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∏–º—è –∫–æ–ª–æ–Ω–∫–∏
                            if (headerMap['–î–∞—Ç–∞'] === undefined || headerMap[expectedHeaderEvents] === undefined) {
                                parseError = `–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ CSV. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ '–î–∞—Ç–∞' –∏–ª–∏ '${expectedHeaderEvents}'.\n–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏: ${Object.keys(headerMap).join(', ')}`;
                                break;
                            }
                            headerProcessed = true;
                            console.log("Import (Per-Day): Processed CSV Header:", headerMap);
                            continue;
                        }

                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö CSV
                        const fields = parseCsvLine(line);

                        if (fields.length < Object.keys(headerMap).length) {
                            console.warn("Import (Per-Day): Skipping malformed CSV line (not enough fields):", line, "Expected:", Object.keys(headerMap).length, "Got:", fields.length);
                            continue;
                        }
                        
                        const dateStr = fields[headerMap['–î–∞—Ç–∞']];
                        if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                            console.warn("Import (Per-Day): Skipping line with invalid date format:", dateStr, "Line:", line);
                            continue;
                        }
                        dataLinesProcessed++;

                        // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º ?? –¥–ª—è –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫)
                        importedAllDayDetails[dateStr] = {
                            calories: {
                                morning: parseInt(fields[headerMap['–ö–∞–ª–æ—Ä–∏–∏ —É—Ç—Ä–æ–º']]) || 0,
                                afternoon: parseInt(fields[headerMap['–ö–∞–ª–æ—Ä–∏–∏ –¥–Ω–µ–º']]) || 0,
                                evening: parseInt(fields[headerMap['–ö–∞–ª–æ—Ä–∏–∏ –≤–µ—á–µ—Ä–æ–º']]) || 0,
                            },
                            comment: fields[headerMap['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–Ω—è']] ?? '' // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –µ—Å–ª–∏ undefined
                        };

                        const eventsJsonStr = fields[headerMap['–°–æ–±—ã—Ç–∏—è –î–Ω—è (JSON)']];
                        if (eventsJsonStr) {
                            try {
                                const eventsForDay = JSON.parse(eventsJsonStr);
                                if (Array.isArray(eventsForDay)) {
                                    eventsForDay.forEach(eventData => {
                                        const newEvent = {
                                            ...eventData,
                                            id: `evt-${Date.now()}-${Math.random().toString(36).substring(2, 11)}`, // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ ID
                                            date: dateStr // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –¥–∞—Ç–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ CSV
                                        };
                                        importedCalendarEvents.push(newEvent);
                                    });
                                } else {
                                    console.warn(`Import (Per-Day): Events JSON for date ${dateStr} is not an array:`, eventsForDay);
                                }
                            } catch (err) {
                                console.error(`Import (Per-Day): Failed to parse events JSON for date ${dateStr}: "${eventsJsonStr}"`, err);
                                parseError = `–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∞—Ç—ã ${dateStr}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É –≤ CSV —Ñ–∞–π–ª–µ.`;
                                // –†–µ—à–∞–µ–º, –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –ª–∏ –∏–º–ø–æ—Ä—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å
                                // break; // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ —Ö–æ—Ç–∏–º –ø—Ä–µ—Ä–≤–∞—Ç—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ –≤ JSON —Å–æ–±—ã—Ç–∏–π
                            }
                        }
                    } // –∫–æ–Ω–µ—Ü for loop –ø–æ —Å—Ç—Ä–æ–∫–∞–º

                    if (parseError) {
                        alert(parseError);
                        console.error("Import Error (Per-Day):", parseError);
                        if (fileInp.parentNode) fileInp.remove();
                        return;
                    }

                    if (!headerProcessed) {
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ CSV —Ñ–∞–π–ª–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø—É—Å—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏.");
                        if (fileInp.parentNode) fileInp.remove();
                        return;
                    }
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫, –Ω–æ –Ω–µ—Ç —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
                    if (dataLinesProcessed === 0 && importedCalendarEvents.length === 0 && Object.keys(importedAllDayDetails).length === 0 && importedProjects.length === 0) {
                         alert("–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ (—Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–ª–∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏).");
                         if (fileInp.parentNode) fileInp.remove();
                         return;
                    }

                    console.log("Import (Per-Day): Aggregated calendarEvents:", importedCalendarEvents.length, "items");
                    console.log("Import (Per-Day): Aggregated allDayDetails:", Object.keys(importedAllDayDetails).length, "days");
                    console.log("Import (Per-Day): Aggregated projects (from metadata if any):", importedProjects.length, "items");

                    const dataToStore = {
                        projects: importedProjects, // –ë—É–¥—É—Ç –ø—É—Å—Ç—ã–º–∏, –µ—Å–ª–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –Ω–µ –±—ã–ª–æ
                        calendarEvents: importedCalendarEvents,
                        selectedProjectId: importedSelectedProjectId, // –ë—É–¥–µ—Ç null, –µ—Å–ª–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –Ω–µ –±—ã–ª–æ
                        stopwatch: importedStopwatch, // –ë—É–¥–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –Ω–µ –±—ã–ª–æ
                        [ALL_DAY_DETAILS_KEY]: importedAllDayDetails
                    };

                    console.log("Import (Per-Day): Data prepared for storage:", JSON.stringify(dataToStore, null, 2).substring(0,1000) + "...");

                    chrome.storage.local.remove(
                        ['calendarEvents', 'projects', 'selectedProjectId', 'stopwatch', ALL_DAY_DETAILS_KEY], 
                        () => {
                            console.log("Import (Per-Day): Old calendar data removed from storage.");
                            chrome.storage.local.set(dataToStore, () => {
                                if (chrome.runtime.lastError) {
                                    console.error("Import (Per-Day): Error setting data to storage:", chrome.runtime.lastError);
                                    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: " + chrome.runtime.lastError.message);
                                } else {
                                    console.log("Import (Per-Day): New data successfully set to storage.");
                                    alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã! –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞.");
                                    window.location.reload();
                                }
                            });
                        }
                    );

                }; // –∫–æ–Ω–µ—Ü reader.onload

                reader.onerror = (err) => {
                    alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: " + err);
                    console.error("FileReader error:", err);
                    if (fileInp.parentNode) fileInp.remove();
                };
                reader.readAsText(selectedFile, "UTF-8"); // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫—É
                
                if (fileInp.parentNode) { // –£–¥–∞–ª—è–µ–º input –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —á—Ç–µ–Ω–∏—è
                    try { fileInp.remove(); } catch(e) { /*ignore*/ }
                }
            }); // –∫–æ–Ω–µ—Ü fileInp.addEventListener
            document.body.appendChild(fileInp);
            fileInp.click();
        });
    }

    // –ü—Ä–æ—Å—Ç–æ–π CSV –ø–∞—Ä—Å–µ—Ä —Å—Ç—Ä–æ–∫–∏. –£—á–∏—Ç—ã–≤–∞–µ—Ç –∫–∞–≤—ã—á–∫–∏.
    function parseCsvLine(line) {
        const fields = [];
        let currentField = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                // –ï—Å–ª–∏ —ç—Ç–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–∞–≤—ã—á–∫–∞ (""), –¥–æ–±–∞–≤–ª—è–µ–º –æ–¥–Ω—É –∫–∞–≤—ã—á–∫—É –∏ –∏–¥–µ–º –¥–∞–ª—å—à–µ
                if (inQuotes && i + 1 < line.length && line[i+1] === '"') {
                    currentField += '"';
                    i++; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –∫–∞–≤—ã—á–∫—É
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ';' && !inQuotes) {
                fields.push(currentField);
                currentField = '';
            } else {
                currentField += char;
            }
        }
        fields.push(currentField); // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–ª–µ
        return fields;
    }

    async function exportToCSV() {
        console.log("Export process started (Per-Day JSON, NO METADATA BLOCK).");
        const result = await new Promise(resolve =>
            chrome.storage.local.get([
                'calendarEvents', /*'projects', 'selectedProjectId', 'stopwatch', */ ALL_DAY_DETAILS_KEY // –£–±—Ä–∞–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –Ω—É–∂–Ω—ã –í–û–û–ë–©–ï –≤ —Ñ–∞–π–ª–µ
            ], data => {
                console.log("Data fetched from storage for export:", data);
                resolve(data);
            })
        );

        const localCalendarEvents = result.calendarEvents || [];
        const localAllDayDetails = result[ALL_DAY_DETAILS_KEY] || {};
        // const localProjects = result.projects || []; // –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç—ã –≤—Å–µ –∂–µ –Ω—É–∂–Ω—ã –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –≤ —Å–æ–±—ã—Ç–∏—è—Ö –¥–Ω—è

        // –ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –ø—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–æ–∫ ID –ø—Ä–æ–µ–∫—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –≤ —Å–æ–±—ã—Ç–∏—è—Ö, –∞ –Ω–µ –≤–µ—Å—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫
        // –≠—Ç–æ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å, –µ—Å–ª–∏ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ –Ω–µ –Ω—É–∂–µ–Ω –≤ —ç–∫—Å–ø–æ—Ä—Ç–µ.
        // –ù–æ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ª—É—á—à–µ –∏–º–µ—Ç—å –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫.
        // –ï—Å–ª–∏ –≤—ã —Ä–µ—à–∏—Ç–µ, —á—Ç–æ —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ –≤—Å–µ –∂–µ –Ω—É–∂–µ–Ω, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—ã—à–µ
        // –∏ –ø–µ—Ä–µ–¥–∞—á—É –≤ JSON-–±–ª–æ–∫ –≤ –∫–æ–Ω—Ü–µ (–µ—Å–ª–∏ –æ–Ω –≤–µ—Ä–Ω–µ—Ç—Å—è) –∏–ª–∏ –≤ –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è).

        let allDatesSet = new Set(localCalendarEvents.map(ev => ev.date));
        Object.keys(localAllDayDetails).forEach(dateStr => allDatesSet.add(dateStr));
        let uniqueDates = Array.from(allDatesSet).sort();

        let header = [
            "–î–∞—Ç–∞", "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏",
            "–ö–∞–ª–æ—Ä–∏–∏ —É—Ç—Ä–æ–º", "–ö–∞–ª–æ—Ä–∏–∏ –¥–Ω–µ–º", "–ö–∞–ª–æ—Ä–∏–∏ –≤–µ—á–µ—Ä–æ–º", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–Ω—è",
            "–°–æ–±—ã—Ç–∏—è –î–Ω—è (JSON)" // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏, —á—Ç–æ —Ç—É—Ç —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è, –Ω–µ "–ø—Ä–æ–µ–∫—Ç—ã" –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
        ];

        let csvContent = '\uFEFF' + header.join(';') + '\n';

        uniqueDates.forEach(dateStr => {
            let dateObj = new Date(dateStr + "T00:00:00");
            let dayOfWeek = dateObj.toLocaleDateString('ru-RU', { weekday: "short" });
            
            const details = localAllDayDetails[dateStr] || {};
            const cals = details.calories || {};

            const eventsForThisDay = localCalendarEvents
                .filter(ev => ev.date === dateStr)
                .map(ev => {
                    return { // –¢–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è –¥–Ω—è
                        title: ev.title,
                        description: ev.description,
                        startTime: ev.startTime,
                        endTime: ev.endTime,
                        projectId: ev.projectId, // ID –ø—Ä–æ–µ–∫—Ç–∞, –∫ –∫–æ—Ç–æ—Ä–æ–º—É —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ
                        type: ev.type,
                        isLive: ev.isLive 
                        // id —Å–∞–º–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –Ω–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º, —Ç.–∫. –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –±—É–¥–µ–º –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π
                    };
                });
            
            const eventsJsonString = JSON.stringify(eventsForThisDay);
            const escapedJsonString = eventsJsonString.replace(/"/g, '""');

            let row = [
                `"${dateStr}"`,
                `"${dayOfWeek}"`,
                `"${cals.morning || 0}"`,
                `"${cals.afternoon || 0}"`,
                `"${cals.evening || 0}"`,
                `"${(details.comment || '').replace(/"/g, '""')}"`,
                `"${escapedJsonString}"`
            ];
            
            csvContent += row.join(';') + '\n';
        });

        // –£–ë–ò–†–ê–ï–ú JSON-–ë–õ–û–ö –° –ú–ï–¢–ê–î–ê–ù–ù–´–ú–ò –í –ö–û–ù–¶–ï –§–ê–ô–õ–ê
        // console.log('Metadata backup object (NOT ADDED TO CSV):', JSON.stringify(metadataBackup, null, 2));
        // csvContent += "\n" + JSON.stringify(metadataBackup) + "\n"; // –≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ —É–¥–∞–ª–µ–Ω–∞

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `calendar_data_by_day_${formatDate(new Date()).replace(/-/g, '')}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        console.log("Export process finished (Per-Day JSON, STRICTLY NO METADATA BLOCK).");
    }


    // ------ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø SCROLL -------- (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    const weekGridEl = document.querySelector('.calendar-scroll');
    const timeSlotsScroll = document.querySelector('.time-slots-scroll');

    if (weekGridEl && timeSlotsScroll) {
        let scrollingSelf = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è
        weekGridEl.addEventListener('scroll', () => {
            if (scrollingSelf) return;
            scrollingSelf = true;
            timeSlotsScroll.scrollTop = weekGridEl.scrollTop;
            requestAnimationFrame(() => scrollingSelf = false); // –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –∫–∞–¥—Ä–µ
        });
        timeSlotsScroll.addEventListener('scroll', () => {
            if (scrollingSelf) return;
            scrollingSelf = true;
            weekGridEl.scrollTop = timeSlotsScroll.scrollTop;
           requestAnimationFrame(() => scrollingSelf = false);
        });
    }


    // ==== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====
    function initialLoad() {
        chrome.storage.local.get(
            ['calendarEvents', 'projects', 'selectedProjectId', 'stopwatch', ALL_DAY_DETAILS_KEY], 
            res => {
                console.log("InitialLoad: Data fetched from storage:", JSON.stringify(res, null, 2));
                calendarEvents = res.calendarEvents || [];
                projects = res.projects || [];
                // selectedProjectId –º–æ–∂–µ—Ç –±—ã—Ç—å null, –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω –∏–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
                selectedProjectId = res.selectedProjectId !== undefined ? res.selectedProjectId : null; 
                stopwatch = res.stopwatch || { isRunning: false, elapsed: 0, startTimestamp: null, liveEventId: null, projectId: null };
                allDayDetailsData = res[ALL_DAY_DETAILS_KEY] || {};

                console.log(`InitialLoad: Loaded ${calendarEvents.length} events.`);
                console.log(`InitialLoad: Loaded day details for ${Object.keys(allDayDetailsData).length} days.`);

                renderProjectSelectAndList(); // –û–±–Ω–æ–≤–∏—Ç select, selectedProjectId –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                renderProjectStats(selectedProjectId);
                renderTimeSlots(); 
                renderDaysHeader(currentWeekStart); 
                renderWeekGrid(currentWeekStart); 
                loadStopwatchState();

                if (typeof DayDetails === 'function' && !dayDetailsManager) {
                    dayDetailsManager = new DayDetails();
                }
        });
    }

    
    // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ storage
    chrome.storage.onChanged.addListener((changes, area) => {
        if (area === "local") {
            let UINeedsFullRefresh = false;
            let headersNeedRefresh = false;

            if ('stopwatch' in changes) {
                loadStopwatchState(); // –≠—Ç–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ —Ä–µ—Ñ—Ä–µ—à–∞
            }
            if ('calendarEvents' in changes) {
                calendarEvents = changes.calendarEvents.newValue || [];
                renderWeekGrid(currentWeekStart); // –¢–æ–ª—å–∫–æ —Å–µ—Ç–∫—É —Å–æ–±—ã—Ç–∏–π
                renderProjectStats(selectedProjectId); // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–≥–ª–∞ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
            }
            if ('projects' in changes) {
                projects = changes.projects.newValue || [];
                UINeedsFullRefresh = true; // –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤, –≤—ã–±–æ—Ä, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            }
             if ('selectedProjectId' in changes) {
                selectedProjectId = changes.selectedProjectId.newValue || null;
                // renderProjectSelectAndList(); // –û–±–Ω–æ–≤–∏—Ç —Å–µ–ª–µ–∫—Ç
                // renderProjectStats(selectedProjectId);
                // updateStopwatchUI(); // –ö–Ω–æ–ø–∫–∏ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–∞ –º–æ–≥—É—Ç –∑–∞–≤–∏—Å–µ—Ç—å
                 UINeedsFullRefresh = true; // –ü—Ä–æ—â–µ –ø–æ–ª–Ω—ã–π —Ä–µ—Ñ—Ä–µ—à –¥–ª—è —ç—Ç–æ–≥–æ
            }
            if (ALL_DAY_DETAILS_KEY in changes) {
                allDayDetailsData = changes[ALL_DAY_DETAILS_KEY].newValue || {};
                headersNeedRefresh = true;
            }

            if (UINeedsFullRefresh) {
                initialLoad(); // –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä UI
            } else if (headersNeedRefresh) {
                renderDaysHeader(currentWeekStart); // –¢–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            }
        }
    });

    initialLoad();

    function updateCurrentTimeIndicator() {
        let indicator = weekGridContainer.querySelector('.current-time-indicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.className = 'current-time-indicator';
            // –ï–≥–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–ª–æ–Ω–∫—É –¥–Ω—è
        }
        const now = new Date();
        const todayDateStr = formatDate(now);
        const todayColumn = weekGridContainer.querySelector(`.day-column[data-date="${todayDateStr}"]`);

        if (todayColumn) {
            if (!indicator.parentNode) { // –ï—Å–ª–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω
                 // –ò—â–µ–º —Å–∞–º—ã–π –ø–µ—Ä–≤—ã–π hour-cell –≤ –∫–æ–ª–æ–Ω–∫–µ, —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–≥–æ
                const firstHourCellInTodayColumn = todayColumn.querySelector('.hour-cell');
                if (firstHourCellInTodayColumn) {
                    firstHourCellInTodayColumn.appendChild(indicator); 
                }
            }
            const minutes = now.getHours() * 60 + now.getMinutes();
            const totalMinutesInDay = 24 * 60;
            const percentageOfDay = (minutes / totalMinutesInDay);
            
            // –í—ã—Å–æ—Ç–∞ –≤—Å–µ–π –∫–æ–ª–æ–Ω–∫–∏ (–≤—Å–µ—Ö hour-cell)
            // –≠—Ç–æ –¥–æ–ø—É—â–µ–Ω–∏–µ, —á—Ç–æ –≤—Å–µ hour-cell –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –≤—ã—Å–æ—Ç—ã –∏ –∏—Ö 24
            // –õ—É—á—à–µ –ø–æ–ª—É—á–∏—Ç—å –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ .day-column, –µ—Å–ª–∏ –æ–Ω –∏–º–µ–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É –¥–ª—è 24—á
            const dayColumnHeight = todayColumn.offsetHeight; 

            indicator.style.top = `${percentageOfDay * dayColumnHeight}px`;
            indicator.style.display = 'block';
        } else {
            indicator.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –Ω–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        }
    }
    setInterval(updateCurrentTimeIndicator, 60000); // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
});
